---
title: "Label cell types"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

Here, we will manually label cells based on their cell type. This is done
based on the labelling scheme in ...

## Load data

First, we will load the previously generated `SingleCellExperiment` and 
`CytoImageList` objects.

```{r laod-data, message=FALSE}
library(cytomapper)

sce <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
images <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/images.rds")
masks <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/masks.rds")
```

## Label images

We will now label cells on images and save them. 

```{r label-images, message=FALSE}
images <- CytoImageList(images, on_disk = FALSE)
masks <- CytoImageList(masks, on_disk = FALSE)

if (interactive()) {
  cytomapperShiny(object = sce, mask = masks, image = images,
                  cell_id = "ObjectNumber", img_id = "sample_id")
}
```

## Quality control

We next check for labelling quality.

```{r read-labels}
library(SingleCellExperiment)
label.files <- list.files("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/gated_cells/", full.names = TRUE)

# Read in SCE objects
cur_sces <- lapply(label.files, readRDS)

# Merge SCE objects
cur_sce <- do.call("cbind", cur_sces)

# now we check if the celltypes were labelled uniquely
names <- gsub("_[0-9]*\\w$", "", unique(cur_sce$cytomapper_CellLabel))
unique(names)

# Clean up cell-type names
cur_sce$cytomapper_CellLabel <- gsub("_[0-9]*\\w$", "", cur_sce$cytomapper_CellLabel)

table(cur_sce$cytomapper_CellLabel, cur_sce$indication)
```

We next need to remove cells that were assigned to different cell types.
For these cell, the classification uncertainty will be highest.

```{r redefine-cells}
cur_vec <- cur_sce$cytomapper_CellLabel

cur_tab <- unclass(table(colnames(cur_sce), cur_sce$cytomapper_CellLabel))
cur_labels <- rep("doublets", nrow(cur_tab))

# Single assignments
cur_labels[rowSums(cur_tab) == 1] <- colnames(cur_tab)[apply(cur_tab[rowSums(cur_tab) == 1,], 1,  which.max)]

table(cur_labels)

# Remove doublets
names(cur_labels) <- rownames(cur_tab)
cur_labels <- cur_labels[cur_labels != "doublets"]
table(cur_labels)

# Store in SingleCellExperiment
sce_labels <- rep("unlabelled", ncol(sce))
names(sce_labels) <- colnames(sce)
sce_labels[names(cur_labels)] <- cur_labels
sce$cell_labels <- sce_labels

table(sce$cell_labels, sce$indication)
```

## Define colour vector

In this step, we will define a colour vector for all further visualization purposes.

```{r define-color-vector, fig.height=7, fig.width=7}
cell_types <- c("B_cell", "CD38", "CD4", "CD8", "Treg", "BnCD4", "BnCD8",
                "DC", "HLADR", "Macrophage", "Neutrophil", "NK_cell", "pDC", "Stroma", 
                "Tumor", "unlabelled")

names(cell_types) <- cell_types
cell_types["B_cell"] <- "red3"
cell_types["CD38"] <- "goldenrod2"
cell_types["CD4"] <- "palevioletred1"
cell_types["CD8"] <- "darkorchid"
cell_types["Treg"] <- "maroon4"
cell_types["BnCD4"] <- "darkorange4"
cell_types["BnCD8"] <- "red4"
cell_types["DC"] <- "green4"
cell_types["HLADR"] <- "darkgreen"
cell_types["Macrophage"] <- "green"
cell_types["Neutrophil"] <- "blue1"
cell_types["NK_cell"] <- "yellow"
cell_types["pDC"] <- "deepskyblue"
cell_types["Stroma"] <- "tomato"
cell_types["Tumor"] <- "sienna4"
cell_types["unlabelled"] <- "gray"

metadata(sce)$colour_vectors$cell_types <- cell_types

pie(c(rep(1,length(metadata(sce)$colour_vectors$cell_types))),
    col = metadata(sce)$colour_vectors$cell_types,
    labels = names(metadata(sce)$colour_vectors$cell_types))
```

## Quality control of labelling results

Here, we will check a number of statistics to assess labelling quality.

```{r quality-control-1}
# 1. How many cells of how many images are labelled

# Percent cells labelled
as_tibble(colData(sce)) %>% 
  summarise(labelled_cells = sum(cell_labels != "unlabelled")/n()) 

# Percent images labelled
as_tibble(colData(sce)) %>% 
  group_by(sample_id) %>%
  summarise(labelled_cells = sum(cell_labels != "unlabelled")) %>%
  ungroup() %>%
  summarise(labelled_images = sum(labelled_cells != 0)/n())

# Percent patients labelled
as_tibble(colData(sce)) %>% 
  group_by(patient_id) %>%
  summarise(labelled_cells = sum(cell_labels != "unlabelled")) %>%
  ungroup() %>%
  summarise(labelled_samples = sum(labelled_cells != 0)/n())

# Percent of cells labelled per image
as_tibble(colData(sce)) %>% 
  group_by(sample_id) %>%
  summarise(labelled_cells = sum(cell_labels != "unlabelled")/n(),
            number_cells = n()) %>%
  as.data.frame()
```

We will check how balanced the classes are across the images.

```{r quality-control-3}
# Total cells per class
as_tibble(colData(sce)) %>%
  group_by(cell_labels) %>%
  summarise(number_cells = n()) %>%
  as.data.frame()

# Total cells per class and image
as_tibble(colData(sce)) %>%
  filter(cell_labels != "unlabelled") %>%
  group_by(cell_labels, sample_id) %>%
  summarise(number_cells = n()) %>%
  DT::datatable()
```

## Visualize markers and cells

Now, we will check the expression of selected markers across the classes and visualize cell labels on tSNE.

```{r quality-control-4, fig.width=15, fig.height=20}
library(scran)
library(dittoSeq)
library(viridis)

lab_sce <- sce[,sce$cell_labels != "unlabelled"]
agr_sce <- aggregateAcrossCells(lab_sce, 
                                ids = colData(lab_sce)[,c("sample_id", "cell_labels")], 
                                statistics = "mean")
assay(agr_sce, "exprs") <- asinh(counts(agr_sce))
colnames(agr_sce) <- paste0(agr_sce$sample_id, "_", 
                            agr_sce$cell_labels)

# Define markers that were used for gating
cur_markers <- c("Ecad", "CarbonicAnhydrase", "Ki67", "CD14", "HLADR", 
                 "CD11c", "CD163", "CD303", "CD68", "CD15", "MPO", "CD38",
                 "SMA", "PDGFRb", "CD20", "CD7", "CD3", "CD8a", "CD4", "GrzB", "FOXP3", "PD1")

# Non-scaled
dittoHeatmap(agr_sce[cur_markers,], assay = "exprs",
            annot.by = c("patient_id", "cell_labels", "indication"), 
            cluster_rows = FALSE,
            scale = "none", heatmap.colors = viridis(100), order.by = "cell_labels",
            annotation_colors = list(patient_id = metadata(sce)$colour_vectors$PatientIds,
                                     cell_labels = metadata(sce)$colour_vectors$cell_types,
                                     indication = metadata(sce)$colour_vectors$Indication))

# Centered and scaled
dittoHeatmap(agr_sce[cur_markers,], assay = "exprs",
            annot.by = c("patient_id", "cell_labels", "indication"), 
            cluster_rows = FALSE, order.by = "cell_labels",
            annotation_colors = list(patient_id = metadata(sce)$colour_vectors$PatientIds,
                                     cell_labels = metadata(sce)$colour_vectors$cell_types,
                                     indication = metadata(sce)$colour_vectors$Indication),
            heatmap.colors = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            breaks = seq(-3, 3, length.out = 101))
```

Finally, we will represent the gated cells on tSNE.

```{r tsne}
cur_unlab_sce <- sce[,sce$cell_labels == "unlabelled"]
cur_lab_sce <- sce[,sce$cell_labels != "unlabelled"]

ggplot() +
    geom_point(aes(x = UMAP_1, y = UMAP_2, colour = cell_labels), 
              data = data.frame(UMAP_1 = reducedDim(cur_unlab_sce, "UMAP_fastMNN")[,1],
                                UMAP_2 = reducedDim(cur_unlab_sce, "UMAP_fastMNN")[,2],
                                cell_labels = colData(cur_unlab_sce)$cell_labels)) +
    geom_point(aes(x = UMAP_1, y = UMAP_2, colour = cell_labels), size = 0.5, 
            data = data.frame(UMAP_1 = reducedDim(cur_lab_sce, "UMAP_fastMNN")[,1],
                              UMAP_2 = reducedDim(cur_lab_sce, "UMAP_fastMNN")[,2],
                              cell_labels = colData(cur_lab_sce)$cell_labels)) +
    scale_color_manual(values = metadata(sce)$colour_vectors$cell_types) + 
    theme_bw()
```

# Save SCE object

```{r save_sce}
saveRDS(sce, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
```

