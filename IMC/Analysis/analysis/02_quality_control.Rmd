---
title: "Quality control"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

Here, we will perform quality control on all samples with focus
on batch effects, cell number per images and cell size.

## Load data and libraries

First, we will load all relevant data and libraries.

```{r load-data, message=FALSE}
library(tidyverse)
library(dittoSeq)
library(scater)
library(viridis)

sce <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
```

## Cell numbers

We will now visualize how many cells we detected per image and patient.

```{r cell-numbers}
# Plot number of cells
colData(sce) %>%
  as_tibble() %>%
  group_by(patient_id, ROI) %>%
  summarize(count = n()) %>%
  ggplot() +
    geom_bar(aes(patient_id, count, fill = ROI), 
             position = "stack", stat = "identity") +
    scale_fill_manual(values = metadata(sce)$colour_vectors$ROIs) + 
    theme_minimal(base_size = 15) + theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Numeric output
colData(sce) %>%
  as_tibble() %>%
  group_by(patient_id, ROI) %>%
  summarize(count = n()) %>%
  summary()
```

## Cell size

We will now observe the distribution of cell sizes across all images.

```{r cell-size, message=FALSE, fig.height=10, fig.width=10}
# Add column names
colnames(sce) <- paste(sce$patient_id, sce$ROI, sce$ObjectNumber, sep = "_")

dittoPlot(sce, var = "area", group.by = "image",  
          plots = "ridgeplot", color.panel = metadata(sce)$colour_vectors$ROIs) 

summary(sce$area)
```

We will now filter cells based on size.

```{r filter-cells}
sum(sce$area < 5)
sum(sce$area > 400)

sce <- sce[,sce$area >= 5 & sce$area <= 400]
```

## Expression differences

We will now visualize the expression differences between patients.

```{r expression-differences, fig.height=25}
multi_dittoPlot(sce, vars = rownames(sce)[rowData(sce)$use_channel],
               group.by = "patient_id", plots = c("ridgeplot"), 
               assay = "exprs", 
               color.panel = metadata(sce)$colour_vectors$PatientId)
```

We also compute a tSNE and UMAP of all cells to visualize potential sample effects.

```{r dimred}
set.seed(220321)
sce <- runTSNE(sce, subset_row = rowData(sce)$use_channel, exprs_values = "exprs")
sce <- runUMAP(sce, subset_row = rowData(sce)$use_channel, exprs_values = "exprs")
```

We can now visualize the patient IDs and expression on the UMAPs.

```{r dimred-viz-patient-indication, message=FALSE}
dittoDimPlot(sce, var = "patient_id", reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(sce)$colour_vectors$PatientIds) +
    ggtitle("Patient ID on UMAP")

dittoDimPlot(sce, var = "indication", reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(sce)$colour_vectors$Indication) +
    ggtitle("Patient ID on UMAP")
```

```{r dimred-viz-expression, fig.height=12, fig.width=12}
multi_dittoDimPlot(sce, vars = rownames(sce)[rowData(sce)$use_channel], 
                   reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis() 
```

## Save object

Finally, we will save the modified `SingleCellExperiment` object.

````{r save-RDS}
saveRDS(sce, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
```
