---
title: "Reading in the data"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

In this script, we read in the single-cell and image data generated by the 
[steinbock](https://github.com/BodenmillerGroup/steinbock) framework. 

# Load libraries

First, we will load the libraries needed for this part of the analysis.

```{r load-libraries, message=FALSE}
library(S4Vectors)
library(SingleCellExperiment)
library(tidyverse)
library(imcRtools)
library(tools)
```

# Read in the single-cell data

We use `imcRtools` to read in the data:

```{r read-data}
sce <- read_steinbock("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/", 
                      return_as = "sce", 
                      extract_imagemetadata_from = c("width_px",	"height_px",	
                                                     "acquisition_id"))
sce$image <- paste0(sce$sample_id, ".tiff")
sce$patient_id <- str_extract(sce$image, "[0-9]{8}")
assay(sce, "exprs") <- asinh(counts(sce))

# Specify interesting channels
rowData(sce)$use_channel <- !grepl("DNA|HistoneH3", rownames(sce))
```

## Image-level metadata

Here, we will collect all relevant image-level metadata for these samples.
These will be added to the cell-level metadata.

```{r clean-meta}
meta <- read.csv("data/sample_metadata.csv")

cell_meta <- merge(colData(sce), meta, 
                   by = "patient_id", sort = FALSE)

all.equal(paste(cell_meta$image, cell_meta$ObjectNumber), 
          paste(sce$image, sce$ObjectNumber))

colData(sce) <- cell_meta

sce$ROI <- file_path_sans_ext(str_split(sce$image, "_", simplify = TRUE)[,5])
```

## Generate colour vectors

At this point we want to generate color vectors that we can reproducibly and consistently use throughout the analysis.
Primarily, we will define colors for 1. the samples, 2. the ROI, 3. the indication.

```{r generate-colour-vectors}
library(dittoSeq)
library(RColorBrewer)
colour_vectors <- list()

col_vec_patientIds <- dittoColors(reps = 3)[seq_len(length(unique(sce$patient_id)))]
names(col_vec_patientIds) <- unique(sce$patient_id)

col_vec_ROIs <- colorRampPalette(c("dark green", "white", "dark red"))(length(unique(sce$ROI)))
names(col_vec_ROIs) <- unique(sce$ROI)

col_vec_indication <- c(CRC = "#5B1C55", SCCHN = "#39BEB4", NSCLC = "#F79C1D", 
                        BCC = "#3F85A7", RCC = "#C81F43")

colour_vectors$PatientIds <- col_vec_patientIds
colour_vectors$ROIs <- col_vec_ROIs
colour_vectors$Indication <- col_vec_indication

# Save in metadata slot
metadata(sce)$colour_vectors <- colour_vectors
```

## Define colors 

Here, we define colors for matched cell types and samples.

```{r define-colors}
library(RColorBrewer)
color_vectors <- list()
matched_celltype <- setNames(c("#3F1B03", "#0A3A03", "#066970", "#894F36", "#636160", "#DC6FE2", "#BF0A3D", "#F4800C"),
                             c("Tumor", "Tcell", "Neutrophil", "Macrophage",
                               "other", "DC", "Bcell", "BnTcell"))
patient_id <- setNames(brewer.pal(8, "Set1"),
                       c("10061074", "10067433", "10068868", "10071582", "10073140", "10074349", "10074832", "10075371"))
color_vectors$matched_celltype <- matched_celltype
color_vectors$patient_id <- patient_id

metadata(sce)$color_vectors <- color_vectors
```

## Add interaction graph

Finally, we will add a 20Âµm expansion interaction graph to compare to mIF.

```{r buildSpatialGraph, message=FALSE}
library(imcRtools)
sce <- buildSpatialGraph(sce, img_id = "sample_id", type = "expansion",
                         threshold = 20, name = "expansion_20")
```


## Save SCE object

Finally, for easy accessability, we will write the SCE object out.
The object will be stored on the server so that everyone can work with it.

```{r save-RDS, warning=FALSE}
dir.create("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/")
saveRDS(sce, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
```

# Read in image data

Here, we read in the images and masks and save them on disk.

```{r read-images, message = FALSE, warning=FALSE}
dir.create("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/h5/")
dir.create("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/h5/images")
dir.create("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/h5/masks")

library(cytomapper)
images <- loadImages("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/img/", on_disk = TRUE, 
                     h5FilesPath = "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/h5/images")
masks <- loadImages("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/masks/", on_disk = TRUE, 
                     h5FilesPath = "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/h5/masks",
                    as.is = TRUE)

channelNames(images) <- rownames(sce)

mcols(images) <- mcols(masks) <- DataFrame(image = names(images),
                                           sample_id = sub(".tiff", "", names(images)))

saveRDS(images, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/images.rds")
saveRDS(masks, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/masks.rds")
```
