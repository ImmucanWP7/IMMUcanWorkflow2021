---
title: "Predict cell types"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

Here, we will use the previously trained random forest classifier to 
predict all unlabelled cells.

## Load data

First, we will read in the SingleCellExperiment object and load all libraries.

```{r read-sce, message = FALSE}
library(caret)
library(scater)
library(tidyverse)
library(dittoSeq)
library(viridis)
library(doParallel)

sce <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
images <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/images.rds")
masks <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/masks.rds")

lab_sce <- sce[,sce$cell_labels != "unlabelled"]
unlab_sce <- sce[,sce$cell_labels == "unlabelled"]

rffit <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/rf_classifier.rds")
```

## Prediction based on labelled cells

We will predict the labels of all other cells.
For cell-type classification, we will use the method that was trained across all images. 

```{r predict-cells}
# Add dummy variables
cur_mat <- t(assay(unlab_sce, "exprs")[!grepl("DNA|Histone", rownames(unlab_sce)),])

dummies <- dummyVars(sample_id ~ indication, data = colData(unlab_sce))
all_dummies <- predict(dummies, newdata = colData(unlab_sce))

cur_mat <- cbind(cur_mat, all_dummies)

cell_labels.class <- as.character(predict.train(rffit, 
              newdata = cur_mat, 
              type = "raw"))
names(cell_labels.class) <- rownames(cur_mat)
cell_labels.prob <- predict.train(rffit, 
              newdata = cur_mat, 
              type = "prob")

library(ggridges)

# Distribution of maximum probabilities
tibble(max_prob = rowMax(as.matrix(cell_labels.prob)),
       type = cell_labels.class) %>%
    ggplot() +
        geom_density_ridges(aes(x = max_prob, y = type, fill = type)) +
        scale_fill_manual(values = metadata(sce)$colour_vectors$cell_types) +
        theme_classic(base_size = 15) +
        xlab("Maximum probability") +
        ylab("Cell type") + 
        xlim(c(0,1.2))

cell_labels.class[rowMax(as.matrix(cell_labels.prob)) < 0.2] <- "undefined"
```

Store predictions in SCE object.
We will not overwrite the labels of the already labelled cells.

```{r store-predictions}
cell_labels <- sce$cell_labels
cell_labels[colnames(unlab_sce)] <- cell_labels.class

sce$celltypes <- cell_labels 

cur_probs <- matrix(NA, ncol = ncol(cell_labels.prob), nrow = ncol(sce))
rownames(cur_probs) <- colnames(sce)
colnames(cur_probs) <- colnames(cell_labels.prob)
cur_probs[rownames(cell_labels.prob),] <- as.matrix(cell_labels.prob)

sce$probabilities <- DataFrame(cur_probs)
```

### Visualization of reduced dimensions

First, we will plot the class labels on the batch corrected tSNEs.

```{r red-dim-visualization-classlabels, message = FALSE, warning = FALSE}
library(dittoSeq)

dittoDimPlot(sce, reduction.use = "UMAP_fastMNN", var = "celltypes", size = 0.2) +
  scale_color_manual(values = metadata(sce)$colour_vectors$cell_types)

dittoDimPlot(sce, reduction.use = "UMAP_fastMNN", var = "indication", size = 0.2) +
  scale_color_manual(values = metadata(sce)$colour_vectors$Indication)
```

### Visualization of marker expression

Finally, we will visualize the marker expression per cell type using the classified cells.

```{r heatmap-visualization}
unlab_sce <- sce[,sce$cell_labels == "unlabelled"]
agr_sce <- aggregateAcrossCells(unlab_sce, 
                                ids = colData(unlab_sce)[,c("sample_id", "celltypes")], 
                                statistics = "mean")
assay(agr_sce, "exprs") <- asinh(counts(agr_sce))
colnames(agr_sce) <- paste0(agr_sce$sample_id, "_", 
                            agr_sce$celltypes)

# Define markers that were used for gating
cur_markers <- c("Ecad", "CarbonicAnhydrase", "Ki67", "CD14", "HLADR", 
                 "CD11c", "CD163", "CD303", "CD68", "CD15", "MPO", "CD38",
                 "SMA", "PDGFRb", "CD20", "CD7", "CD3", "CD8a", "CD4", "GrzB", "FOXP3", "PD1")

# Non-scaled
dittoHeatmap(agr_sce[cur_markers,], assay = "exprs",
            annot.by = c("patient_id", "celltypes", "indication"), 
            cluster_rows = FALSE,
            scale = "none", heatmap.colors = viridis(100), order.by = "celltypes",
            annotation_colors = list(patient_id = metadata(sce)$colour_vectors$PatientIds,
                                     celltypes = metadata(sce)$colour_vectors$cell_types,
                                     indication = metadata(sce)$colour_vectors$Indication))

# Centered and scaled
dittoHeatmap(agr_sce[cur_markers,], assay = "exprs",
            annot.by = c("patient_id", "celltypes", "indication"), 
            cluster_rows = FALSE, order.by = "celltypes",
            annotation_colors = list(patient_id = metadata(sce)$colour_vectors$PatientIds,
                                     celltypes = metadata(sce)$colour_vectors$cell_types,
                                     indication = metadata(sce)$colour_vectors$Indication),
            heatmap.colors = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            breaks = seq(-3, 3, length.out = 101))
```

### Write out example images

Here, we will outline the cells of each cell type onto of composite images.

```{r define-markers-per-celltype, message=FALSE}
library(SingleCellExperiment)
library(cytomapper)

cell_types <- names(metadata(sce)$colour_vectors$cell_types)
cell_types <- cell_types[cell_types != "unlabelled"]

markers <- vector(mode = "list", length = length(cell_types))
names(markers) <- cell_types

markers[["Bcell"]] <- c("CD20", "CD3")
markers[["Plasma"]] <- c("CD38")
markers[["CD4"]] <- c("CD4", "CD8a", "CD3")
markers[["CD8"]] <- c("CD4", "CD8a", "CD3")
markers[["Treg"]] <- c("CD4", "CD8a", "FOXP3")
markers[["BnTcell"]] <- c("CD20", "CD3")
markers[["DC"]] <- c("CD11c", "CD68")
markers[["MacCD163"]] <- c("CD11c", "CD163")
markers[["HLADR"]] <- c("HLADR", "CD11c")
markers[["Neutrophil"]] <- c("CD15", "MPO")
markers[["NK"]] <- c("CD7", "CD3")
markers[["pDC"]] <- c("CD303")
markers[["Mural"]] <- c("SMA", "PDGFRb")
markers[["Tumor"]] <- c("Ecad", "CarbonicAnhydrase")
markers[["undefined"]] <- c("DNA1")
```

Normalize the images.

```{r normalize}
images <- CytoImageList(images, on_disk = FALSE)
masks <- CytoImageList(masks, on_disk = FALSE)

images <- normalize(images, separateImages = TRUE)
images <- normalize(images, separateImages = TRUE, 
                        inputRange = c(0, 0.2))
```

Now, we will loop through the cell-types and indication.

```{r viz-cell-types}
if (!dir.exists("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/CellTypeValidation/")) {
  dir.create("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/CellTypeValidation/")
} 

for(j in unique(sce$celltypes)){
    cur_sce <- sce[,sce$celltypes == j]
    cur_markers <- markers[[j]]
  
    if(dim(cur_sce)[2] == 0) {
      next(j)
    }
    
    if (length(cur_markers) == 1) {
      cur_col <- "red"
      names(cur_col) <- j
      cur_col <- list(cur_col)
      names(cur_col) <- "celltypes"
      plotPixels(image = images, 
                object = cur_sce, 
                mask = masks, 
                cell_id = "ObjectNumber",
                img_id = "sample_id", 
                colour_by = cur_markers, 
                outline_by = "celltypes",
                image_title = list(text = names(images),
                                cex = 1), 
                colour = cur_col,
                save_plot = list(filename = paste0("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/CellTypeValidation/",
                            j, ".png")))
    } else {
        plotPixels(image = images,
                   object = cur_sce, 
                   mask = masks, 
                   cell_id = "ObjectNumber",
                   img_id = "sample_id", 
                   colour_by = cur_markers, 
                   outline_by = "celltypes",
                   image_title = list(text = names(images),
                                  cex = 1),
                   save_plot = list(filename = paste0("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/CellTypeValidation/",
                            j, ".png")))
    }
}

```

## Prediction based on external pre-trained classifier

Here, we will use a pre-trained classifier to predict cell types.
We will first adjust the data to match to the classifier

```{r, message=FALSE}
rffit <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/cell_classification/rf_images.rds")

sce$Indication <- sce$indication

sce$Indication[sce$Indication == "BCC"] <- "BREAS"
sce$Indication[sce$Indication == "CRC"] <- "GI"
sce$Indication[sce$Indication == "NSCLC"] <- "GU"
sce$Indication[sce$Indication == "RCC"] <- "HN"
sce$Indication[sce$Indication == "SCCHN"] <- "THOR"
```

### Predict cells

We will now predict all cells in the dataset

```{r predict-cells-2}
library(ggridges)

# Add dummy variables
cur_mat <- t(assay(sce, "exprs")[!grepl("DNA|Histone", rownames(sce)),])

dummies <- dummyVars(sample_id ~ Indication, data = colData(sce))
all_dummies <- predict(dummies, newdata = colData(sce))

cur_mat <- cbind(cur_mat, all_dummies)

cell_labels.class <- as.character(predict.train(rffit, 
              newdata = cur_mat, 
              type = "raw"))
names(cell_labels.class) <- rownames(cur_mat)
cell_labels.prob <- predict.train(rffit, 
              newdata = cur_mat, 
              type = "prob")

cell_labels.class[cell_labels.class == "plasma"] <- "Plasma"
cell_labels.class[cell_labels.class == "B"] <- "Bcell"
cell_labels.class[cell_labels.class == "BnT"] <- "BnTcell"

colnames(cell_labels.prob) <- c("Bcell", "BnTcell", "CD4", "CD8", "DC", "HLADR", "MacCD163", "Mural", 
"Neutrophil", "NK", "pDC", "Plasma", "Treg", "Tumor")

# Distribution of maximum probabilities
tibble(max_prob = rowMax(as.matrix(cell_labels.prob)),
       type = cell_labels.class) %>%
    ggplot() +
        geom_density_ridges(aes(x = max_prob, y = type, fill = type)) +
        scale_fill_manual(values = metadata(sce)$colour_vectors$cell_types) +
        theme_classic(base_size = 15) +
        xlab("Maximum probability") +
        ylab("Cell type") + 
        xlim(c(0,1.2))

cell_labels.class[rowMax(as.matrix(cell_labels.prob)) < 0.3] <- "undefined"
```

Store predictions in SCE object.
We will not overwrite the labels of the already labelled cells.

```{r store-predictions-2}
sce$external_celltypes <- cell_labels.class 
sce$external_probabilities <- DataFrame(cell_labels.prob)
```

### Visualization of reduced dimensions

First, we will plot the class labels on the batch corrected tSNEs.

```{r red-dim-visualization-classlabels-2, message = FALSE, warning = FALSE}
library(dittoSeq)

dittoDimPlot(sce, reduction.use = "UMAP_fastMNN", var = "external_celltypes", size = 0.2) +
  scale_color_manual(values = metadata(sce)$colour_vectors$cell_types)

dittoDimPlot(sce, reduction.use = "UMAP_fastMNN", var = "indication", size = 0.2) +
  scale_color_manual(values = metadata(sce)$colour_vectors$Indication)
```

### Visualization of marker expression

Finally, we will visualize the marker expression per cell type using the classified cells.

```{r heatmap-visualization-2}
agr_sce <- aggregateAcrossCells(sce, 
                                ids = colData(sce)[,c("sample_id", "external_celltypes")], 
                                statistics = "mean")
assay(agr_sce, "exprs") <- asinh(counts(agr_sce))
colnames(agr_sce) <- paste0(agr_sce$sample_id, "_", 
                            agr_sce$external_celltypes)

# Define markers that were used for gating
cur_markers <- c("Ecad", "CarbonicAnhydrase", "Ki67", "CD14", "HLADR", 
                 "CD11c", "CD163", "CD303", "CD68", "CD15", "MPO", "CD38",
                 "SMA", "PDGFRb", "CD20", "CD7", "CD3", "CD8a", "CD4", "GrzB", "FOXP3", "PD1")

# Non-scaled
dittoHeatmap(agr_sce[cur_markers,], assay = "exprs",
            annot.by = c("patient_id", "external_celltypes", "indication"), 
            cluster_rows = FALSE,
            scale = "none", heatmap.colors = viridis(100), order.by = "external_celltypes",
            annotation_colors = list(patient_id = metadata(sce)$colour_vectors$PatientIds,
                                     external_celltypes = metadata(sce)$colour_vectors$cell_types,
                                     indication = metadata(sce)$colour_vectors$Indication))

# Centered and scaled
dittoHeatmap(agr_sce[cur_markers,], assay = "exprs",
            annot.by = c("patient_id", "external_celltypes", "indication"), 
            cluster_rows = FALSE, order.by = "external_celltypes",
            annotation_colors = list(patient_id = metadata(sce)$colour_vectors$PatientIds,
                                     external_celltypes = metadata(sce)$colour_vectors$cell_types,
                                     indication = metadata(sce)$colour_vectors$Indication),
            heatmap.colors = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            breaks = seq(-3, 3, length.out = 101))
```

### Write out example images

Here, we will outline the cells of each cell type onto of composite images.

```{r viz-cell-types-2}
if (!dir.exists("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/external_CellTypeValidation/")) {
  dir.create("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/external_CellTypeValidation/")
} 

for(j in unique(sce$external_celltypes)){
    cur_sce <- sce[,sce$external_celltypes == j]
    cur_markers <- markers[[j]]
  
    if(dim(cur_sce)[2] == 0) {
      next(j)
    }
    
    if (length(cur_markers) == 1) {
      cur_col <- "red"
      names(cur_col) <- j
      cur_col <- list(cur_col)
      names(cur_col) <- "external_celltypes"
      plotPixels(image = images, 
                object = cur_sce, 
                mask = masks, 
                cell_id = "ObjectNumber",
                img_id = "sample_id", 
                colour_by = cur_markers, 
                outline_by = "external_celltypes",
                image_title = list(text = names(images),
                                cex = 1), 
                colour = cur_col,
                save_plot = list(filename = paste0("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/external_CellTypeValidation/",
                            j, ".png")))
    } else {
        plotPixels(image = images,
                   object = cur_sce, 
                   mask = masks, 
                   cell_id = "ObjectNumber",
                   img_id = "sample_id", 
                   colour_by = cur_markers, 
                   outline_by = "external_celltypes",
                   image_title = list(text = names(images),
                                  cex = 1),
                   save_plot = list(filename = paste0("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/external_CellTypeValidation/",
                            j, ".png")))
    }
}

```

## Define matched cell types

To compare to mIF data, we will need to harmonize the cell types.

```{r matched-celltypes}
matched_celltype <- sce$celltypes
matched_celltype[matched_celltype %in% c("Plasma", "HLADR", "Mural", "pDC", "NK")] <- "other"
matched_celltype[matched_celltype %in% c("Treg", "CD4", "CD8")] <- "Tcell"
matched_celltype[matched_celltype == "TumorKi67"] <- "Tumor"
sce$matched_celltype <- matched_celltype

ext_matched_celltype <- sce$external_celltypes
ext_matched_celltype[ext_matched_celltype %in% c("Plasma", "HLADR", "Mural", "pDC", "NK")] <- "other"
ext_matched_celltype[ext_matched_celltype %in% c("Treg", "CD4", "CD8")] <- "Tcell"
ext_matched_celltype[ext_matched_celltype == "TumorKi67"] <- "Tumor"
sce$external_matched_celltype <- ext_matched_celltype
```

# Save RDS

```{r saveRDS}
saveRDS(sce, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
```
