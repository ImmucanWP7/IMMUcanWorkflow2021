---
title: "Analyses to profile the wiggle room in the slidescanner"
author: "Nils Eling"
date: "2021-10-18"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

Here, we want to figure out how "constant" the transformation between 
brightfield images and the .mcds really is.
For this, we have rescanned the slides for IMC using the slide scanner and 
re-computed the post-transformation.

## Distance between control points

In the first instance, I will compute the distance between the two control point
sets of each scan.

### Read in the data

First, I will read in the control points of each set.

```{r, message=FALSE}
library(ggplot2)
points_1 <- list.files("/Volumes/immucan_volume/raw_data/Panel_1/Batch20210304_workflow_paper/IF_regions_validations/control_points_posttransformation/",
                       full.names = TRUE)
points_2 <- list.files("/Volumes/immucan_volume/raw_data/Panel_1/Batch20210304_workflow_paper/IF_regions_validations/control_points_posttransformation_2/",
                       full.names = TRUE)

points_1 <- lapply(points_1, read.csv)
names(points_1) <- list.files("/Volumes/immucan_volume/raw_data/Panel_1/Batch20210304_workflow_paper/IF_regions_validations/control_points_posttransformation/",
                       full.names = FALSE)

points_2 <- lapply(points_2, read.csv)
names(points_2) <- list.files("/Volumes/immucan_volume/raw_data/Panel_1/Batch20210304_workflow_paper/IF_regions_validations/control_points_posttransformation_2/",
                       full.names = FALSE)
```

### Define color vector

Here, we will define a color vector for each sample and each point.

```{r color-vector}
library(RColorBrewer)
col_vec <- brewer.pal(length(points_1), name = "Set3")
names(col_vec) <- names(points_1)
```

### Visualize X and Y offset

First, I will visualize the offset on the X and Y axis.

```{r x-y-offset, fig.width=12}
cur_df <- mapply(function(x, y, n){
  data.frame(dX = x$x_source - y$x_source,
             dY = x$y_source - y$y_source,
             sample = n)
}, points_1, points_2, names(points_1), SIMPLIFY = FALSE)

cur_df <- do.call(rbind, cur_df)

ggplot(cur_df) + geom_point(aes(dX, dY, fill = sample), shape = 21, size = 2) + 
  xlim(c(-400, 400)) + ylim(c(-400,400)) + 
  geom_vline(xintercept = 0, color = "dark red") + 
  geom_hline(yintercept = 0, color = "dark red") +
   scale_fill_manual(values = col_vec) + theme_minimal(base_size = 15)
```

### Visualize the euclidean offset

Now, we will visualize the euclidean distance between control points for each 
sample.

```{r euclidean-offset, fig.width=12}
cur_df <- mapply(function(x, y, n){
  data.frame(euclidean = sqrt((x$x_source - y$x_source)^2 + (x$y_source - y$y_source)^2),
             sample = n)
}, points_1, points_2, names(points_1), SIMPLIFY = FALSE)

cur_df <- do.call(rbind, cur_df)

ggplot(cur_df) + geom_point(aes(sample, euclidean, fill = sample), shape = 21, size = 2) +
  theme_minimal(base_size = 15) +
  theme(axis.text.x = element_blank()) +
   scale_fill_manual(values = col_vec) 
```

