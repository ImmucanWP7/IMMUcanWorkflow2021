---
title: "Alignment from slidescanner to IMC"
author: "Nils Eling"
date: "2021-10-18"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

We will test the offset when aligning the slidescanner and IMC images.

## Distance between control points

We will assess the alignment efficiency based on the distance between validation
points and the transformed points.

### Read in the data

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
points_1 <- list.files("/Volumes/immucan_volume/raw_data/Panel_1/Batch20210304_workflow_paper/IF_regions_validations/validation_points_mcd/",
                       full.names = TRUE)
points_2 <- list.files("/Volumes/immucan_volume/raw_data/Panel_1/Batch20210304_workflow_paper/IF_regions_validations/transformed_points_czi_to_mcd/",
                       full.names = TRUE)

points_1 <- lapply(points_1, read.csv)
names(points_1) <- list.files("/Volumes/immucan_volume/raw_data/Panel_1/Batch20210304_workflow_paper/IF_regions_validations/validation_points_mcd/",
                       full.names = FALSE)

points_2 <- lapply(points_2, read.csv)
names(points_2) <- list.files("/Volumes/immucan_volume/raw_data/Panel_1/Batch20210304_workflow_paper/IF_regions_validations/transformed_points_czi_to_mcd/",
                       full.names = FALSE)
```

### Define color vector

Here, we will define a color vector for each sample and each point.

```{r color-vector}
library(RColorBrewer)
col_vec <- brewer.pal(length(points_1), name = "Set3")
names(col_vec) <- names(points_1)
```

### Visualize X and Y offset

First, I will visualize the offset on the X and Y axis.

```{r x-y-offset, fig.width=10}
library(ggplot2)
cur_df <- mapply(function(x, y, n){
  data.frame(dX = x$X - y$X,
             dY = x$Y - y$Y,
             sample = n,
             point = seq_len(length(x$X)))
}, points_1, points_2, names(points_1), SIMPLIFY = FALSE)

cur_df <- do.call(rbind, cur_df)

ggplot(cur_df) + geom_point(aes(dX, dY, fill = sample), 
                            shape = 21, size = 3) + 
  xlim(c(-400, 400)) + ylim(c(-400,400)) + 
  geom_vline(xintercept = 0, color = "dark red") + 
  geom_hline(yintercept = 0, color = "dark red") + 
  scale_fill_manual(values = col_vec) + theme_minimal(base_size = 15)
```

### Visualize the euclidean offset

Now, we will visualize the euclidean distance between control points for each 
sample.

```{r euclidean-offset, fig.height=7}
cur_df <- mapply(function(x, y, n){
  data.frame(euclidean = sqrt((x$X - y$X)^2 + (x$Y - y$Y)^2),
             sample = n,
             point = seq_len(length(x$X)))
}, points_1, points_2, names(points_1), SIMPLIFY = FALSE)

cur_df <- do.call(rbind, cur_df)

ggplot(cur_df) + geom_point(aes(sample, euclidean, color = as.factor(point))) +
  theme_minimal(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title = element_blank()) + 
  geom_abline(slope = 0, intercept = 100, color = "dark red") +
  ylim(c(0,120))
```

