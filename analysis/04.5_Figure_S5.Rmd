---
title: "Figure 4"
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

Code to generate the plots of Figure 4.

## Read data

```{r, message=FALSE}
library(SingleCellExperiment)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(imcRtools)

mount_path <- "/Volumes/G_DQBM_BB_Central$/projects/immucan"

sce_IMC <- readRDS(file.path(mount_path, "processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds"))
sce_mIF <- readRDS(file.path(mount_path, "processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/sce_ROIs.rds"))
```

# Spatial comparison

## Mergin of data

```{r prepare-data}
# Prepare mIF data
cur_mIF <- sce_mIF
colData(cur_mIF) <- colData(cur_mIF)[,c("sample_id", "patient_id", "nucleus.x", "nucleus.y", "matched_celltype", "tissue.type", "TLS.ID")]
cur_mIF$Pos_X <- cur_mIF$nucleus.x
cur_mIF$Pos_Y <- cur_mIF$nucleus.y

cur_mIF$Pos_X <- cur_mIF$Pos_X * 0.4962
cur_mIF$Pos_Y <- cur_mIF$Pos_Y * 0.4962

cur_mIF$nucleus.x <- NULL
cur_mIF$nucleus.y <- NULL

rowData(cur_mIF) <- NULL
assays(cur_mIF) <- list()
metadata(cur_mIF) <- list()

rownames(cur_mIF) <- NULL

colPairs(cur_mIF) <- NULL
cur_mIF$modality <- "mIF"

# Prepare IMC data
cur_IMC <- sce_IMC
colData(cur_IMC) <- colData(cur_IMC)[,c("sample_id", "patient_id", "matched_celltype", "Pos_X", "Pos_Y")]
cur_IMC$tissue.type <- c("stroma", "tumor")[as.numeric(sce_IMC$tumor_patches) + 1]
cur_IMC$TLS.ID <- sce_IMC$CD20_patches

rowData(cur_IMC) <- NULL
assays(cur_IMC) <- list()
metadata(cur_IMC) <- list()

rownames(cur_IMC) <- NULL
reducedDims(cur_IMC) <- NULL
colPairs(cur_IMC) <- NULL
cur_IMC$modality <- "IMC"

# Merge data
all_sce <- cbind(cur_IMC[1:6,], cur_mIF)
all_sce$sample_id_global <- paste0(all_sce$sample_id, "_", all_sce$modality)
```

## Visualize celltypes between mIF and IMC

```{r}
if (!dir.exists("output/Figure_S5/")) dir.create("output/Figure_S5/")

p <- plotSpatial(all_sce[,all_sce$modality == "IMC"], 
            node_color_by = "matched_celltype", 
            ncols = 4, img_id = "sample_id") + 
  scale_color_manual(values = metadata(sce_IMC)$color_vectors$matched_celltype)

ggsave(filename = "output/Figure_S5/FigS5_1.pdf", plot = p, width = 20, height = 49)

p <- plotSpatial(all_sce[,all_sce$modality == "mIF"], 
            node_color_by = "matched_celltype", 
            ncols = 4, img_id = "sample_id") + 
  scale_color_manual(values = metadata(sce_IMC)$color_vectors$matched_celltype)

ggsave(filename = "output/Figure_S5/FigS5_2.pdf", plot = p, width = 20, height = 49)
```
