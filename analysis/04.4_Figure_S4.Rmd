---
title: "Figure 4"
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

Code to generate the plots of Figure 4.

```{r}
# Set path
if (Sys.info()["sysname"] == "Windows"){
  mount_path <- "O:/projects/immucan/"
} else {
  mount_path <- "/Volumes/G_DQBM_BB_Central$/projects/immucan"
}
```

## Read data

```{r, message=FALSE}
library(SingleCellExperiment)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(imcRtools)


sce_IMC <- readRDS(file.path(mount_path, "processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds"))
sce_mIF <- readRDS(file.path(mount_path, "processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/sce_ROIs.rds"))
```

# Number of cells

```{r}
if (!dir.exists("output/Figure_S4/")) dir.create("output/Figure_S4/")

no_IMC <- colData(sce_IMC) %>% as_tibble() %>%
  group_by(sample_id, patient_id) %>%
  summarize(count = n())
no_mIF <- colData(sce_mIF) %>% as_tibble() %>%
  group_by(sample_id, patient_id) %>%
  summarize(count = n())

combined_df <- left_join(no_IMC, no_mIF, by = c("sample_id", "patient_id"))
combined_df$patient_id <- sub("-", "", str_extract(combined_df$sample_id, "[0-9]{8}-"))

(p <- ggplot(combined_df) + 
  geom_point(aes(count.x, count.y, color = patient_id), size = 2) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  geom_smooth(aes(count.x, count.y), method='lm', formula= y~x, fullrange=TRUE) + 
  theme_minimal(base_size = 20) + xlab("# Cells in IMC") + ylab("# Cells in mIF") +
  coord_fixed() + 
  ylim(c(0, 5000)) + xlim(c(0, 5000)) +
  scale_color_manual(values = metadata(sce_IMC)$color_vectors$patient_id, name = "Patient ID"))

ggsave(filename = "output/Figure_S4/FigS4_A.pdf", plot = p, width = 10, height = 7)
```

# Supporting plots for DA analysis

```{r}
cur_mIF <- colData(sce_mIF)
cur_IMC <- colData(sce_IMC)

# Proportions of cell types for IMC
cur_IMC$matched_celltype <- factor(cur_IMC$matched_celltype)
prop_IMC <- cur_IMC %>% 
  as.data.frame() %>%
  group_by(sample_id, patient_id, matched_celltype, .drop = FALSE) %>%
  summarize(count = n()) %>%
  group_by(sample_id) %>%
  mutate(prop = count/sum(count))

# Proportions of cell types for mIF
cur_mIF$matched_celltype <- factor(cur_mIF$matched_celltype)
prop_mIF <- cur_mIF %>% 
  as.data.frame() %>%
  group_by(sample_id, patient_id, matched_celltype, .drop = FALSE) %>%
  summarize(count = n()) %>%
  group_by(sample_id) %>%
  mutate(prop = count/sum(count))

prop_IMC$modality <- "IMC"
prop_mIF$modality <- "mIF"

out <- rbind(prop_IMC, prop_mIF)

(p <- ggplot(out) + 
  geom_boxplot(aes(modality, prop), outlier.shape = NA) +
  geom_point(aes(modality, prop, color = patient_id)) +
  geom_line(aes(modality, prop, group = sample_id)) +
  facet_wrap(~matched_celltype, nrow = 1, scales = "free")  +
  theme_classic(base_size = 20) +
  ylab("Proportion of cell phenotypes") +
  xlab("Modality") +
  scale_color_manual(values = metadata(sce_IMC)$color_vectors$patient_id, "Patient ID"))

ggsave(filename = "output/Figure_S4/FigS4_B.pdf", plot = p, height = 5, width = 17)
```

Example images

```{r}
library(cytomapper)

(p1 <- plotSpatial(sce_IMC[,sce_IMC$sample_id == "IMMUcan_2022_WFLOW_10073140-SPECT-VAR-TIS-01-IMC-01_004"], 
            img_id = "sample_id", node_color_by = "matched_celltype") +
  scale_color_manual(values = metadata(sce_IMC)$color_vectors$matched_celltype) +
    theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = "black", colour = NA),
        legend.position = "none") + ggtitle(""))

(p2 <- plotSpatial(sce_mIF[,sce_mIF$sample_id == "IMMUcan_2022_WFLOW_10073140-SPECT-VAR-TIS-01-IMC-01_004"], 
            img_id = "sample_id", node_color_by = "matched_celltype", coords = c("nucleus.x", "nucleus.y")) +
  scale_color_manual(values = metadata(sce_IMC)$color_vectors$matched_celltype) +
    theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = "black", colour = NA)) + ggtitle(""))

ggsave(filename = "output/Figure_S4/FigS4_C1.pdf", plot = p1, height = 10, width = 10)
ggsave(filename = "output/Figure_S4/FigS4_C2.pdf", plot = p2, height = 10, width = 10)
```
