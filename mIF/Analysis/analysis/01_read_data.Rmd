---
title: "Read IFQuant data"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

In this script, we will read in the mIF data that was processed by IFQuant.

## Define color vectors

These will be shared across all datasets.

```{r define-colors}
library(RColorBrewer)

color_vectors <- list()
matched_celltype <- setNames(c("coral3", "chartreuse3", "cyan2", "darkgoldenrod2", "grey75", "#DC6FE2", "#BF0A3D", "#F4800C"),
                             c("Tumor", "Tcell", "Neutrophil", "MacCD163",
                               "other", "DC", "Bcell", "BnTcell"))
patient_id <- setNames(brewer.pal(10, "Set3"),
                       c("10082495", "10067433", "10074349", "10075572", "10068868", 
                         "10073140", "10075371", "10061074", "10071582", "10074832"))
color_vectors$matched_celltype <- matched_celltype
color_vectors$patient_id <- patient_id
```

## Read whole slide data

First, we will start with reading in the whole slide data.

```{r, message=FALSE}
library(SingleCellExperiment)
library(tidyverse)

cur_files <- list.files("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/data/whole_slide/", pattern = "cells_properties_", full.names = TRUE)
cur_files_2 <- list.files("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/data/whole_slide/", pattern = "cells_properties2_", full.names = TRUE)

# Map between Lausanne and Zurich IDs
cur_table <- read_csv("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/comparisons/sample_mapping.csv")

# Read in data
cur_sces <- lapply(seq_along(cur_files), function(x){
  cur_data <- read.csv(cur_files[x], sep = "\t")
  cur_counts <- t(cur_data[,grepl("score.normalized", colnames(cur_data))])
  cur_raw <- t(cur_data[,grepl("score$", colnames(cur_data))])
  rownames(cur_counts) <- rownames(cur_raw) <- str_split(rownames(cur_raw), "\\.", 
                                                         simplify = TRUE)[,1]
  cur_sce <- SingleCellExperiment(assays = list(counts = cur_counts,
                                                raw = cur_raw))
  colData(cur_sce) <- DataFrame(cur_data[,!grepl("score", colnames(cur_data))])
  colData(cur_sce)$Lausanne_id <- str_split(str_split(cur_files[x], "/", simplify = TRUE)[,11], "_#_", simplify = TRUE)[,1]
  colData(cur_sce)$Lausanne_id <- unlist(lapply(str_split(colData(cur_sce)$Lausanne_id, "-"), function(y){paste(y[1:3], collapse = "-")}))
  colData(cur_sce)$sample_id <- as.character(cur_table$IMC[match(unique(colData(cur_sce)$Lausanne_id), cur_table$mIF)])
  colData(cur_sce)$patient_id <- as.character(colData(cur_sce)$sample_id)
  
  # Secondary data
  cur_data_2 <- read.csv(cur_files_2[x], sep = "\t")
  
  stopifnot(all.equal(cur_sce$cell.ID, cur_data_2$cell.ID))
  
  cur_cd <- cbind(colData(cur_sce), cur_data_2[,c("cell.area", "TLS.ID")])
  
  colData(cur_sce) <- cur_cd
  
  return(cur_sce)
})

cur_colnames <- Reduce(intersect, lapply(cur_sces, function(x){colnames(colData(x))}))
cur_sces <- lapply(cur_sces, function(x){
  colData(x) <- colData(x)[,cur_colnames]
  return(x)
})

sce <- do.call("cbind", cur_sces)

# Transform counts
assay(sce, "exprs") <- log(counts(sce))

# Add phenotype labels
cur_key <- as.data.frame(read_csv("~/Github/mIF_cell_types/cell_types/phenotype_key_IF1.csv"))

rownames(cur_key) <- cur_key$phenotype

sce$celltype <- cur_key[sce$phenotype,2]
sce$matched_celltype <- sce$celltype
sce$matched_celltype[grepl("Tumor", sce$matched_celltype)] <- "Tumor"
sce$matched_celltype[sce$matched_celltype == "T"] <- "Tcell"
sce$matched_celltype[sce$matched_celltype == "B"] <- "Bcell"
sce$matched_celltype[sce$matched_celltype == "BnT"] <- "BnTcell"
sce$matched_celltype[sce$matched_celltype == "Stromal_cell"] <- "other"

sce$indication <- sce$Lausanne_id
sce$indication[grepl("BC", sce$indication)] <- "BCC"
sce$indication[grepl("CRC", sce$indication)] <- "CRC"
sce$indication[grepl("NSCLC", sce$indication)] <- "NSCLC"
sce$indication[grepl("RCC", sce$indication)] <- "RCC"
sce$indication[grepl("SCCHN", sce$indication)] <- "SCCHN"

metadata(sce)$color_vectors <- color_vectors

saveRDS(sce, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/sce_whole_slide.rds")
```

## Read matched ROI information

We will read in the tsv files that contain cells from the same region as 
the IMC acquisition and store them in `SingleCellExperiment` objects.

```{r load-data, message=FALSE}
cur_files <- list.files("/Volumes/GoogleDrive/My Drive/IMMUcan_workflow/data/Lausanne_data/final/",
                        recursive = TRUE, 
                        pattern = "cells_properties_ROI_coordinates.tsv.gz", full.names = TRUE)

cur_sces <- lapply(cur_files, function(x){
  cur_data <- read.csv(x, sep = "\t")
  cur_counts <- t(cur_data[,grepl("score.normalized", colnames(cur_data))])
  cur_raw <- t(cur_data[,grepl("score$", colnames(cur_data))])
  rownames(cur_counts) <- rownames(cur_raw) <- str_split(rownames(cur_raw), "\\.", 
                                                         simplify = TRUE)[,1]
  cur_sce <- SingleCellExperiment(assays = list(counts = cur_counts,
                                                raw = cur_raw))
  colData(cur_sce) <- DataFrame(cur_data[,!grepl("score", colnames(cur_data))])
  
  colData(cur_sce)$sample_id <- str_extract(x, "IMMUcan_[2|B].*00[1-9]{1}")
  colData(cur_sce)$patient_id <- sub("-", "", str_extract(cur_sce$sample_id, "[0-9]{8}-"))
  colData(cur_sce)$ROI <- str_extract(cur_sce$sample_id, "00[1-9]{1}$")
  
  # Add additional information from whole slide
  cur_sce_2 <- sce[,sce$patient_id == unique(cur_sce$patient_id)]
  cur_df <- colData(cur_sce_2)[match(cur_sce$cell.ID, cur_sce_2$cell.ID),]
  
  # Sanity check that phenotypes and cell IDs match
  stopifnot(all.equal(cur_sce$phenotype, cur_df$phenotype))
  stopifnot(all.equal(cur_sce$cell.ID, cur_df$cell.ID))
  
  # Transfer cell area and TLS id
  colData(cur_sce) <- cbind(colData(cur_sce), cur_df[,c("cell.area", "TLS.ID")])
  
  return(cur_sce)
})

cur_colnames <- Reduce(intersect, lapply(cur_sces, function(x){colnames(colData(x))}))
cur_sces <- lapply(cur_sces, function(x){
  colData(x) <- colData(x)[,cur_colnames]
  return(x)
})

sce <- do.call("cbind", cur_sces)

# Transform counts
assay(sce, "exprs") <- log(counts(sce))

metadata(sce)$color_vectors <- color_vectors
```

### Cell type annotation

We will now annotate the cells based on the celltype annotation key.

```{r cell-type-annotation, message=FALSE}
sce$celltype <- cur_key[sce$phenotype,2]
sce$matched_celltype <- sce$celltype
sce$matched_celltype[grepl("Tumor", sce$matched_celltype)] <- "Tumor"
sce$matched_celltype[sce$matched_celltype == "T"] <- "Tcell"
sce$matched_celltype[sce$matched_celltype == "B"] <- "Bcell"
sce$matched_celltype[sce$matched_celltype == "BnT"] <- "BnTcell"
sce$matched_celltype[sce$matched_celltype == "Stromal_cell"] <- "other"
```

### Add interaction graph

Finally, we will add a 20µm expansion interaction graph.

```{r buildSpatialGraph, message=FALSE, fig.height=12, fig.width=12}
library(imcRtools)
# 30µm expansion graph
sce <- buildSpatialGraph(sce, img_id = "sample_id", type = "expansion", 
                         coords = c("nucleus.x", "nucleus.y"),
                         threshold = 60, name = "expansion_60")

# 20µm expansion graph
sce <- buildSpatialGraph(sce, img_id = "sample_id", type = "expansion", 
                         coords = c("nucleus.x", "nucleus.y"),
                         threshold = 40, name = "expansion_40")

plotSpatial(sce, img_id = "sample_id", coords = c("nucleus.x", "nucleus.y"), 
            draw_edges = TRUE, colPairName = "expansion_60", node_size_fix = 0.1,
            nodes_first = TRUE)

plotSpatial(sce, img_id = "sample_id", coords = c("nucleus.x", "nucleus.y"), 
            draw_edges = TRUE, colPairName = "expansion_40", node_size_fix = 0.1,
            nodes_first = TRUE)
```

### Save object

Finally, we will save the generated object

```{r}
saveRDS(sce, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/sce_ROIs.rds")
```

### Read images

```{r, message=FALSE}
library(cytomapper)

images <- loadImages("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/multichannel_images/img/", as.is = TRUE)

channelNames(images) <- c("af", "CD11c", "CD15", "CD163", "CD20", "CD3", "CK", "DAPI")

mcols(images) <- DataFrame(image = names(images),
                          sample_id = sub(".tiff", "", names(images)))

saveRDS(images, "/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/images.rds")
```


