---
title: "Comparison between IMC and IF"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

In this script, we will compare the celltypes observed in mIF with those in IMC.

## Load data

First, we will read in the `SingleCellExperiment` objects storing the IMC and 
IF data.

```{r read-data, message=FALSE}
library(SingleCellExperiment)
library(tidyverse)

sce_IMC <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
sce_mIF <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/steinbock/Rout/sce.rds")
```

## Number of cells

First, we will observe the number of cells per image.

```{r number-of cells}
no_IMC <- colData(sce_IMC) %>% as_tibble() %>%
  group_by(sample_id) %>%
  summarize(count = n())
no_mIF <- colData(sce_mIF) %>% as_tibble() %>%
  group_by(sample_id) %>%
  summarize(count = n())

combined_df <- merge(no_IMC, no_mIF, by="sample_id", sort=FALSE)
combined_df$patient_id <- sub("-", "", str_extract(combined_df$sample_id, "[0-9]{8}-"))

ggplot(combined_df) + 
  geom_point(aes(count.x, count.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  geom_smooth(aes(count.x, count.y), method='lm', formula= y~x, fullrange=TRUE) + 
  theme_minimal() + xlab("# Cells in IMC") + ylab("# Cells in mIF") + coord_fixed()

# With patient as covariate
ggplot(combined_df) + 
  geom_point(aes(count.x, count.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  geom_smooth(aes(count.x, count.y, color = patient_id), method='lm', formula= y~x,
              fullrange=FALSE, se= FALSE) + 
  theme_minimal() + xlab("# Cells in IMC") + ylab("# Cells in mIF") +
  coord_fixed()
```

## Compare expression of cell types

As heatmaps

## Marker expression

Here, we will min-max scale the marker expression per image and compare binned rank averages.

```{r binned-ranks}
cur_IMC <-  lapply(unique(sce_IMC$sample_id), function(k){
  cur_sce_IMC <- sce_IMC[,sce_IMC$sample_id == k]
  cur_sce_IMC <- cur_sce_IMC[c("CD15", "Ecad", "CD3", "CD11c", "CD20", "CD163"),]
  rownames(cur_sce_IMC) <- c("CD15", "CK", "CD3", "CD11c", "CD20", "CD163")
  assay(cur_sce_IMC, "scaled") <- (assay(cur_sce_IMC, "exprs") - 
                                     rowMin(assay(cur_sce_IMC, "exprs"))) / 
                                  (rowMax(assay(cur_sce_IMC, "exprs")) - 
                                     rowMin(assay(cur_sce_IMC, "exprs")))
  
  cur_aggr_IMC <- lapply(rownames(cur_sce_IMC), function(x){
    cur_marker_IMC <- assay(cur_sce_IMC, "scaled")[x,]
    cur_out <- aggregate(cur_marker_IMC, by = list(ntile(cur_marker_IMC, 100)), mean)
    cur_out$marker <- x
    return(cur_out)
  })
  cur_aggr_IMC <- do.call(rbind, cur_aggr_IMC)
  cur_aggr_IMC$sample_id <- k 
  
  return(cur_aggr_IMC)
})
cur_IMC <- do.call(rbind, cur_IMC)

cur_IF <- lapply(unique(sce_mIF$sample_id), function(k){
  cur_sce_IF <- sce_mIF[,sce_mIF$sample_id == k]
  assay(cur_sce_IF, "scaled") <- (assay(cur_sce_IF, "exprs") - 
                                     rowMin(assay(cur_sce_IF, "exprs"))) / 
                                  (rowMax(assay(cur_sce_IF, "exprs")) - 
                                     rowMin(assay(cur_sce_IF, "exprs")))
  
  cur_aggr_IF <- lapply(rownames(cur_sce_IF), function(x){
    cur_marker_IF <- assay(cur_sce_IF, "scaled")[x,]
    cur_out <- aggregate(cur_marker_IF, by = list(ntile(cur_marker_IF, 100)), mean)
    cur_out$marker <- x
    return(cur_out)
  })
  cur_aggr_IF <- do.call(rbind, cur_aggr_IF)
  cur_aggr_IF$sample_id <- k 
  
  return(cur_aggr_IF)
})

cur_IF <- do.call(rbind, cur_IF)

combined_df <- merge(cur_IMC, cur_IF, by = c("Group.1", "marker", "sample_id"), sort = FALSE)
```

Visualize the results

```{r marker-expression-viz}
ggplot(combined_df) +
  geom_line(aes(x.x, x.y, color = sample_id)) + 
  geom_smooth(aes(x.x, x.y), color = "red") +
  facet_wrap(. ~ marker) + 
  geom_abline(intercept = 0, slope = 1, color = "dark red") + 
  theme(legend.position = "none") + xlab("Expression IMC") + ylab("Expression IF")
```
