---
title: "Comparison between IMC and IF"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

In this script, we will compare the celltypes observed in mIF with those in IMC.

## Load data

First, we will read in the `SingleCellExperiment` objects storing the IMC and 
IF data.

```{r read-data, message=FALSE}
library(SingleCellExperiment)
library(tidyverse)

sce_IMC <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
sce_mIF <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/sce_ROIs.rds")

sce_IMC$matched_celltype <- sce_IMC$external_matched_celltype

sce_IMC$matched_celltype[sce_IMC$matched_celltype == "undefined"] <- "other"
```

## Number of cells

First, we will observe the number of cells per image.

```{r number-of-cells}
no_IMC <- colData(sce_IMC) %>% as_tibble() %>%
  group_by(sample_id) %>%
  summarize(count = n())
no_mIF <- colData(sce_mIF) %>% as_tibble() %>%
  group_by(sample_id) %>%
  summarize(count = n())

combined_df <- merge(no_IMC, no_mIF, by="sample_id", sort=FALSE)
combined_df$patient_id <- sub("-", "", str_extract(combined_df$sample_id, "[0-9]{8}-"))

ggplot(combined_df) + 
  geom_point(aes(count.x, count.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  geom_smooth(aes(count.x, count.y), method='lm', formula= y~x, fullrange=TRUE) + 
  theme_minimal() + xlab("# Cells in IMC") + ylab("# Cells in mIF") +
  coord_fixed()

# With patient as covariate
ggplot(combined_df) + 
  geom_point(aes(count.x, count.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  geom_smooth(aes(count.x, count.y, color = patient_id), method='lm', formula= y~x,
              fullrange=FALSE, se= FALSE) + 
  theme_minimal() + xlab("# Cells in IMC") + ylab("# Cells in mIF") +
  coord_fixed()
```

## Cell type fractions

Next, we will compare the cell type fractions between the technologies.

```{r celltype-fractions, fig.width=8, fig.height=10}
# Match cell types
cur_mIF <- colData(sce_mIF)
cur_IMC <- colData(sce_IMC)

frac_IMC <- cur_IMC %>% as_tibble() %>%
  group_by(sample_id, matched_celltype, .drop = FALSE) %>%
  summarize(count = n()) %>%
  mutate(frac = count/sum(count))

frac_mIF <- cur_mIF %>% as_tibble() %>%
  group_by(sample_id, matched_celltype, .drop = FALSE) %>%
  summarize(count = n()) %>%
  mutate(frac = count/sum(count))

combined_df <- merge(frac_IMC, frac_mIF, by=c("sample_id", "matched_celltype"), sort=FALSE)
combined_df$patient_id <- sub("-", "", str_extract(combined_df$sample_id, "[0-9]{8}-"))

ggplot(combined_df) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  geom_smooth(aes(frac.x, frac.y), method='lm', formula= y~x, fullrange=TRUE) + 
  theme_classic(base_size = 20) + xlab("Fraction cell types in IMC") + ylab("Fraction cell types in mIF") +
  facet_wrap(.~matched_celltype, scales = "fixed") 

ggplot(combined_df) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  geom_smooth(aes(frac.x, frac.y), method='lm', formula= y~x, fullrange=TRUE) + 
  theme_classic(base_size = 12) + xlab("Fraction cell types in IMC") + ylab("Fraction cell types in mIF") +
  facet_wrap(.~matched_celltype, scales = "free") 

ggplot(combined_df) + 
  geom_smooth(aes(frac.x, frac.y, color = patient_id),  se = FALSE, method='lm', formula= y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  theme_classic(base_size = 20) + xlab("Fraction cell types in IMC") + ylab("Fraction cell types in mIF") + 
  facet_wrap(.~matched_celltype, scales = "free") 
```

We will also now compute the correlation coefficients.

```{r correlation}
combined_df %>%
  group_by(matched_celltype) %>%
  mutate(cor_all = cor(frac.x, frac.y)) %>%
  ungroup() %>%
  group_by(matched_celltype, patient_id) %>%
  summarize(cor = cor(frac.x, frac.y),
            cor_all = mean(cor_all)) %>%
  ggplot() +
    geom_boxplot(aes(matched_celltype, cor)) +
    geom_point(aes(matched_celltype, cor, color = patient_id)) +
    geom_point(aes(matched_celltype, cor_all), color = "dark red", size = 3) +
    theme_classic(base_size = 20) + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


## Absolute number of cells

We will now compare the absolute number of detected cell types.

```{r, fig.width=10, fig.height=10}
abs_IMC <- cur_IMC %>% as_tibble() %>%
  group_by(sample_id, matched_celltype, .drop = FALSE) %>%
  summarize(count = n()) 

abs_mIF <- cur_mIF %>% as_tibble() %>%
  group_by(sample_id, matched_celltype, .drop = FALSE) %>%
  summarize(count = n()) 

combined_df <- merge(abs_IMC, abs_mIF, by=c("sample_id", "matched_celltype"), sort=FALSE)
combined_df$patient_id <- sub("-", "", str_extract(combined_df$sample_id, "[0-9]{8}-"))

ggplot(combined_df) + 
  geom_point(aes(count.x, count.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  geom_smooth(aes(count.x, count.y), method='lm', formula= y~x, fullrange=TRUE) + 
  theme_classic(base_size = 20) + xlab("Absolute cell types in IMC") + ylab("Absolute cell types in mIF") +
  facet_wrap(.~matched_celltype, scales = "fixed") 

ggplot(combined_df) + 
  geom_smooth(aes(count.x, count.y, color = patient_id),  se = FALSE, method='lm', formula= y~x, fullrange=TRUE) + 
  geom_point(aes(count.x, count.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red") +
  theme_classic(base_size = 20) + xlab("Absolute cell types in IMC") + ylab("Absolute cell types in mIF") + 
  facet_wrap(.~matched_celltype, scales = "free") 
```

## Perform differential abundance analysis

We will next test for systematic biases in cell type abundances between the 
two technologies.

```{r test-DA, message=FALSE}
library(edgeR)
library(ggrepel)

abundances_IMC <- cur_IMC %>% as_tibble() %>%
  group_by(sample_id, matched_celltype) %>%
  summarize(count = n()) %>%
  pivot_wider(names_from = sample_id, 
              values_from = count, values_fill = 0) %>%
  as.data.frame()
rownames(abundances_IMC) <- abundances_IMC$matched_celltype
abundances_IMC$matched_celltype <- NULL
meta_IMC <- data.frame(sample_id = colnames(abundances_IMC),
                       patient_id = sub("-", "", str_extract(colnames(abundances_IMC), "[0-9]{8}-")),
                       modality = "IMC")

abundances_IF <- cur_mIF %>% as_tibble() %>%
  group_by(sample_id, matched_celltype) %>%
  summarize(count = n()) %>%
  pivot_wider(names_from = sample_id, 
              values_from = count, values_fill = 0) %>%
  as.data.frame()
rownames(abundances_IF) <- abundances_IF$matched_celltype
abundances_IF$matched_celltype <- NULL
meta_IF <- data.frame(sample_id = colnames(abundances_IF),
                       patient_id = sub("-", "", str_extract(colnames(abundances_IMC), "[0-9]{8}-")),
                       modality = "IF")

colnames(abundances_IMC) <- paste(abundances_IMC, "IMC")
colnames(abundances_IF) <- paste(abundances_IF, "IF")

combined_df <- cbind(abundances_IMC, abundances_IF[rownames(abundances_IMC),])
combined_meta <- rbind(meta_IMC, meta_IF)

# DA testing
y.ab <- DGEList(combined_df, samples=combined_meta, group = combined_meta$modality)

# Define the design matrix for the model: Add Patient ID to the model to account for matched design, add Location to account for different tumor regions, add tissue type as an additive factor
design <- model.matrix(~sample_id + modality, data = y.ab$samples)

# Estimate NB and QL dispersion
y.ab <- estimateDisp(y.ab, design, trend="none")
summary(y.ab$common.dispersion)
plotBCV(y.ab, cex=1)
fit.ab <- glmQLFit(y.ab, design, robust=TRUE, abundance.trend=FALSE)
summary(fit.ab$var.prior)
plotQLDisp(fit.ab, cex=1)

# Test for differential abundance of cell types in PT vs met tissue and plot
res <- glmQLFTest(fit.ab, coef=colnames(fit.ab)[ncol(fit.ab)])
summary(decideTests(res))
DA <- topTags(res)$table

DA$celltype <- rownames(DA)
DA$sign <- DA$FDR<0.05
DA

# Volcano plot
ggplot(DA) + geom_point(aes(logFC, -log10(FDR), color = sign)) +
  geom_label_repel(aes(logFC, -log10(FDR), label = celltype)) + 
  theme_classic()

# MA plot
ggplot(DA) + geom_point(aes(logCPM, logFC, color = sign)) +
  geom_label_repel(aes(logCPM, logFC, label = celltype)) + 
  geom_abline(intercept = 0, slope = 0, color = "dark red") +
  theme_classic(base_size = 20)
```

## Compare expression of cell types

As heatmaps

## Marker expression

Here, we will min-max scale the marker expression per image and compare binned rank averages.

```{r binned-ranks}
cur_IMC <-  lapply(unique(sce_IMC$sample_id), function(k){
  cur_sce_IMC <- sce_IMC[,sce_IMC$sample_id == k]
  cur_sce_IMC <- cur_sce_IMC[c("CD15", "Ecad", "CD3", "CD11c", "CD20", "CD163"),]
  rownames(cur_sce_IMC) <- c("CD15", "CK", "CD3", "CD11c", "CD20", "CD163")
  assay(cur_sce_IMC, "scaled") <- (assay(cur_sce_IMC, "exprs") - 
                                     rowMin(assay(cur_sce_IMC, "exprs"))) / 
                                  (rowMax(assay(cur_sce_IMC, "exprs")) - 
                                     rowMin(assay(cur_sce_IMC, "exprs")))
  
  cur_aggr_IMC <- lapply(rownames(sce_mIF), function(x){
    cur_marker_IMC <- assay(cur_sce_IMC, "scaled")[x,]
    cur_out <- aggregate(cur_marker_IMC, by = list(ntile(cur_marker_IMC, 100)), mean)
    cur_out$marker <- x
    return(cur_out)
  })
  cur_aggr_IMC <- do.call(rbind, cur_aggr_IMC)
  cur_aggr_IMC$sample_id <- k 
  
  return(cur_aggr_IMC)
})
cur_IMC <- do.call(rbind, cur_IMC)

cur_IF <- lapply(unique(sce_mIF$sample_id), function(k){
  cur_sce_IF <- sce_mIF[,sce_mIF$sample_id == k]
  assay(cur_sce_IF, "scaled") <- (assay(cur_sce_IF, "exprs") - 
                                     rowMin(assay(cur_sce_IF, "exprs"))) / 
                                  (rowMax(assay(cur_sce_IF, "exprs")) - 
                                     rowMin(assay(cur_sce_IF, "exprs")))
  
  cur_aggr_IF <- lapply(rownames(sce_mIF), function(x){
    cur_marker_IF <- assay(cur_sce_IF, "scaled")[x,]
    cur_out <- aggregate(cur_marker_IF, by = list(ntile(cur_marker_IF, 100)), mean)
    cur_out$marker <- x
    return(cur_out)
  })
  cur_aggr_IF <- do.call(rbind, cur_aggr_IF)
  cur_aggr_IF$sample_id <- k 
  
  return(cur_aggr_IF)
})

cur_IF <- do.call(rbind, cur_IF)

combined_df <- merge(cur_IMC, cur_IF, by = c("Group.1", "marker", "sample_id"), sort = FALSE)
```

Visualize the results

```{r marker-expression-viz}
ggplot(combined_df) +
  geom_line(aes(x.x, x.y, color = sample_id)) + 
  facet_wrap(. ~ marker) + 
  geom_abline(intercept = 0, slope = 1, color = "dark red") + 
  theme(legend.position = "none") + xlab("Expression IMC") + ylab("Expression IF")
```

## Visualization on images

We will next plot the location of celltypes on the images.

```{r, image-viz, eval=FALSE}
library(cytomapper)
images_mIF <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/images.rds")
images_IMC <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/images.rds")

for (i in unique(sce_IMC$sample_id)) {
  
  if (! i %in% names(images_mIF)) next
  
  cur_IMC <- plotPixels(images_IMC[i], 
                        colour_by = c("Ecad", "CD3", "CD20", "CD163", "CD15", "CD11c"),
                        return_images = TRUE, image_title = NULL, 
                        scale_bar = NULL, legend = NULL,
                        bcg = list(Ecad = c(0, 5, 1),
                                   CD3 = c(0, 5, 1),
                                   CD20 = c(0, 5, 1),
                                   CD163 = c(0, 5, 1),
                                   CD15 = c(0, 5, 1),
                                   CD11c = c(0, 5, 1)))
  
    cur_mIF <- plotPixels(images_mIF[i], 
                        colour_by = c("CK", "CD3", "CD20", "CD163", "CD15", "CD11c"),
                        return_images = TRUE, image_title = NULL, 
                        scale_bar = NULL, legend = NULL,
                        bcg = list(Ecad = c(0, 5, 1),
                                   CD3 = c(0, 5, 1),
                                   CD20 = c(0, 5, 1),
                                   CD163 = c(0, 5, 1),
                                   CD15 = c(0, 5, 1),
                                   CD11c = c(0, 5, 1)))
    
    # Add points to IMC
    cur_sce_IMC <- sce_IMC[,sce_IMC$sample_id == i]
    cur_sce_mIF <- sce_mIF[,sce_mIF$sample_id == i]
    pdf(file = paste0("~/SIB Swiss Institute of Bioinformatics/Robin Liechti - Workflow2021/comparisons/images_celltypes/", i, ".pdf"))
    plot(cur_IMC$images[[1]])
    points(cur_sce_IMC$Pos_X, cur_sce_IMC$Pos_Y, 
           col = "white", 
           pch = 16, cex = 1.1)
    points(cur_sce_IMC$Pos_X, cur_sce_IMC$Pos_Y, 
           col = metadata(cur_sce_IMC)$colour_vectors$matched_celltype[cur_sce_IMC$matched_celltype], 
           pch = 16, cex = 0.9)
    plot(cur_mIF$images[[1]])
    points(cur_sce_mIF$nucleus.x, cur_sce_mIF$nucleus.y, 
           col = "white", 
           pch = 16, cex = 1.1)
    points(cur_sce_mIF$nucleus.x, cur_sce_mIF$nucleus.y, 
           col = metadata(cur_sce_mIF)$color_vectors$matched_celltype[cur_sce_mIF$matched_celltype], 
           pch = 16, cex = 0.9)
    dev.off()
  
}

# Write out legend
pdf(file = paste0("~/SIB Swiss Institute of Bioinformatics/Robin Liechti - Workflow2021/comparisons/images_celltypes/legend.pdf"))
plot(1:8, y = rep(1, 8), col = metadata(sce_IMC)$color_vectors$matched_celltype, pch = 16, cex = 2)
text(1:8, y = rep(0.8, 8), labels = names(metadata(sce_IMC)$color_vectors$matched_celltype))
text(2, y = 1.2, labels = "Celltypes")
plot(1:6, y = rep(1, 6), col = c("red", "green", "blue", "cyan", "magenta", "yellow"), pch = 16, cex = 2)
text(1:6, y = rep(0.8, 6), labels = c("Ecad", "CD3", "CD20", "CD163", "CD15", "CD11c"))
text(2, y = 1.2, labels = "Marker expression")
dev.off()
```

## Save out data

For cell type comparison I will now write out the x/y cooridnates and cell labels
for the IMC and mIF data.

```{r}
for (i in unique(sce_IMC$sample_id)) {
    cur_sce_IMC <- sce_IMC[,sce_IMC$sample_id == i]
    cur_sce_mIF <- sce_mIF[,sce_mIF$sample_id == i]
   
    write_tsv(as.data.frame(colData(cur_sce_IMC)), paste0("~/SIB Swiss Institute of Bioinformatics/Robin Liechti - Workflow2021/Zurich_data/data_for_comparisons/IMC_cells/", i, ".tsv"))   
        write_tsv(as.data.frame(colData(cur_sce_mIF)), paste0("~/SIB Swiss Institute of Bioinformatics/Robin Liechti - Workflow2021/Zurich_data/data_for_comparisons/mIF_cells//", i, ".tsv"))   
}
```
