---
title: "Figure 4"
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

Code to generate the plots of Figure 4.

## Read data

```{r, message=FALSE}
library(SingleCellExperiment)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(imcRtools)

sce_IMC <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
sce_mIF <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/sce_ROIs.rds")
```

## Example images

```{r}
cur_mIF <- sce_IMC[,sce_IMC$sample_id == ""]
```

## Cell phenotype correlation

```{r}
if (!dir.exists("output/Figure_4/")) dir.create("output/Figure_4/")

# Match cell types
cur_mIF <- colData(sce_mIF)
cur_IMC <- colData(sce_IMC)

cur_mIF$sample_id <- as.factor(cur_mIF$sample_id)
cur_mIF$matched_celltype <- as.factor(cur_mIF$matched_celltype)
cur_IMC$sample_id <- as.factor(cur_IMC$sample_id)
cur_IMC$matched_celltype <- as.factor(cur_IMC$matched_celltype)

frac_IMC <- cur_IMC %>% as_tibble() %>%
  group_by(sample_id, matched_celltype, .drop = FALSE) %>%
  summarize(count = n()) %>%
  mutate(frac = count/sum(count))

frac_mIF <- cur_mIF %>% as_tibble() %>%
  group_by(sample_id, matched_celltype, .drop = FALSE) %>%
  summarize(count = n()) %>%
  mutate(frac = count/sum(count))

combined <- left_join(frac_IMC, frac_mIF, by=c("sample_id", "matched_celltype"))
combined$patient_id <- sub("-", "", str_extract(combined$sample_id, "[0-9]{8}-"))

(p_B <- ggplot(combined[combined$matched_celltype == "B",]) +
  stat_smooth(aes(frac.x, frac.y, color = patient_id), alpha = 0.5, se = FALSE, method='lm', formula = y~x, fullrange=FALSE, geom = "line") + 
  geom_smooth(aes(frac.x, frac.y), se = TRUE, method='lm', formula = y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red", lwd = 1.5) +
  theme_classic(base_size = 20) + xlab("") + ylab("") + 
  scale_color_manual(values = c(metadata(sce_IMC)$color_vectors$ROIs, metadata(sce_IMC)$color_vectors$patient_id)) +
  ylim(c(0, 0.3)) + xlim(c(0, 0.3)) +
  stat_regline_equation(aes(frac.x, frac.y, label = paste(..eq.label.., ..rr.label.., sep = "~~~~")), size = 5) +
  theme(legend.position = "none") +
  ggtitle("B cells") +
  coord_fixed())

(p_BnT <- ggplot(combined[combined$matched_celltype == "BnT",]) +
  stat_smooth(aes(frac.x, frac.y, color = patient_id), alpha = 0.5, se = FALSE, method='lm', formula = y~x, fullrange=FALSE, geom = "line") + 
  geom_smooth(aes(frac.x, frac.y), se = TRUE, method='lm', formula = y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red", lwd = 1.5) +
  theme_classic(base_size = 20) + xlab("") + ylab("") + 
  scale_color_manual(values = c(metadata(sce_IMC)$color_vectors$ROIs, metadata(sce_IMC)$color_vectors$patient_id)) +
  ylim(c(0, 0.4)) + xlim(c(0, 0.4)) +
  stat_regline_equation(aes(frac.x, frac.y, label = paste(..eq.label.., ..rr.label.., sep = "~~~~")), size = 5) +
  theme(legend.position = "none") +
  ggtitle("BnT cells") +
  coord_fixed())

(p_T <- ggplot(combined[combined$matched_celltype == "T",]) +
  stat_smooth(aes(frac.x, frac.y, color = patient_id), alpha = 0.5, se = FALSE, method='lm', formula = y~x, fullrange=FALSE, geom = "line") + 
  geom_smooth(aes(frac.x, frac.y), se = TRUE, method='lm', formula = y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red", lwd = 1.5) +
  theme_classic(base_size = 20) + xlab("") + ylab("") + 
  scale_color_manual(values = c(metadata(sce_IMC)$color_vectors$ROIs, metadata(sce_IMC)$color_vectors$patient_id)) +
  ylim(c(0, 0.6)) + xlim(c(0, 0.6)) +
  stat_regline_equation(aes(frac.x, frac.y, label = paste(..eq.label.., ..rr.label.., sep = "~~~~")), size = 5) +
  theme(legend.position = "none") +
  ggtitle("T cells") +
  coord_fixed())

(p_Mac <- ggplot(combined[combined$matched_celltype == "MacCD163",]) +
  stat_smooth(aes(frac.x, frac.y, color = patient_id), alpha = 0.5, se = FALSE, method='lm', formula = y~x, fullrange=FALSE, geom = "line") + 
  geom_smooth(aes(frac.x, frac.y), se = TRUE, method='lm', formula = y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red", lwd = 1.5) +
  theme_classic(base_size = 20) + xlab("") + ylab("") + 
  scale_color_manual(values = c(metadata(sce_IMC)$color_vectors$ROIs, metadata(sce_IMC)$color_vectors$patient_id)) +
  ylim(c(0, 0.3)) + xlim(c(0, 0.3)) +
  stat_regline_equation(aes(frac.x, frac.y, label = paste(..eq.label.., ..rr.label.., sep = "~~~~")), size = 5) +
  theme(legend.position = "none") +
  ggtitle("Macrophages") +
  coord_fixed())

(p_DC <- ggplot(combined[combined$matched_celltype == "DC",]) +
  stat_smooth(aes(frac.x, frac.y, color = patient_id), alpha = 0.5, se = FALSE, method='lm', formula = y~x, fullrange=FALSE, geom = "line") + 
  geom_smooth(aes(frac.x, frac.y), se = TRUE, method='lm', formula = y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red", lwd = 1.5) +
  theme_classic(base_size = 20) + xlab("") + ylab("") + 
  scale_color_manual(values = c(metadata(sce_IMC)$color_vectors$ROIs, metadata(sce_IMC)$color_vectors$patient_id)) +
  ylim(c(0, 0.2)) + xlim(c(0, 0.2)) +
  stat_regline_equation(aes(frac.x, frac.y, label = paste(..eq.label.., ..rr.label.., sep = "~~~~")), size = 5) +
  theme(legend.position = "none") +
  ggtitle("DC") +
  coord_fixed())

(p_Neutro <- ggplot(combined[combined$matched_celltype == "Neutrophil",]) +
  stat_smooth(aes(frac.x, frac.y, color = patient_id), alpha = 0.5, se = FALSE, method='lm', formula = y~x, fullrange=FALSE, geom = "line") + 
  geom_smooth(aes(frac.x, frac.y), se = TRUE, method='lm', formula = y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red", lwd = 1.5) +
  theme_classic(base_size = 20) + xlab("") + ylab("") + 
  scale_color_manual(values = c(metadata(sce_IMC)$color_vectors$ROIs, metadata(sce_IMC)$color_vectors$patient_id)) +
  ylim(c(0, 0.2)) + xlim(c(0, 0.2)) +
  stat_regline_equation(aes(frac.x, frac.y, label = paste(..eq.label.., ..rr.label.., sep = "~~~~")), size = 5) +
  theme(legend.position = "none") +
  ggtitle("Neutrophils") +
  coord_fixed())

(p_Tumor <- ggplot(combined[combined$matched_celltype == "Tumor",]) +
  stat_smooth(aes(frac.x, frac.y, color = patient_id), alpha = 0.5, se = FALSE, method='lm', formula = y~x, fullrange=FALSE, geom = "line") + 
  geom_smooth(aes(frac.x, frac.y), se = TRUE, method='lm', formula = y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red", lwd = 1.5) +
  theme_classic(base_size = 20) + xlab("") + ylab("") + 
  scale_color_manual(values = c(metadata(sce_IMC)$color_vectors$ROIs, metadata(sce_IMC)$color_vectors$patient_id)) +
  ylim(c(0, 0.8)) + xlim(c(0, 0.8)) +
  stat_regline_equation(aes(frac.x, frac.y, label = paste(..eq.label.., ..rr.label.., sep = "~~~~")), size = 5) +
  theme(legend.position = "none") +
  ggtitle("Tumor cells") +
  coord_fixed())

(p_other <- ggplot(combined[combined$matched_celltype == "other",]) +
  stat_smooth(aes(frac.x, frac.y, color = patient_id), alpha = 0.5, se = FALSE, method='lm', formula = y~x, fullrange=FALSE, geom = "line") + 
  geom_smooth(aes(frac.x, frac.y), se = TRUE, method='lm', formula = y~x, fullrange=TRUE) + 
  geom_point(aes(frac.x, frac.y, color = patient_id)) + 
  geom_abline(slope = 1, intercept = 0, color = "dark red", lwd = 1.5) +
  theme_classic(base_size = 20) + xlab("") + ylab("") + 
  scale_color_manual(values = c(metadata(sce_IMC)$color_vectors$ROIs, metadata(sce_IMC)$color_vectors$patient_id)) +
  ylim(c(0, 0.7)) + xlim(c(0, 0.7)) +
  stat_regline_equation(aes(frac.x, frac.y, label = paste(..eq.label.., ..rr.label.., sep = "~~~~")), size = 5) +
  theme(legend.position = "none") +
  ggtitle("Other cells") +
  coord_fixed())

p_final <- plot_grid(p_T, p_B, p_BnT, p_Tumor, p_Mac, p_DC, p_other, p_Neutro, nrow = 1) + labs(caption = "test")

ggsave(filename = "output/Figure_4/Figure_4B_1.pdf", plot = p_final, width = 40)
```

