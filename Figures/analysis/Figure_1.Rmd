---
title: "Figure 1"
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

Code to generate the plots of Figure 1.

## Read data

```{r, message=FALSE}
library(SingleCellExperiment)
library(tidyverse)
library(imcRtools)

sce_imc <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/IMC/Rout/sce.rds")
sce_mIF <- readRDS("/Volumes/immucan_volume/processed_data/Panel_1/2022_WORKFLOW/mIF/Rout/sce_whole_slide.rds")

sce_imc
sce_mIF

unique(sce_imc$celltypes)
unique(sce_mIF$celltype)
```

## IMC

### Sample area

```{r}
colData(sce_imc) %>%
  as_tibble() %>%
  select(sample_id, width_px, height_px) %>%
  unique() %>%
  mutate(area = width_px * height_px / (1000 * 1000)) %>%
  summarize(total = sum(area))
```

### IMC Example image

```{r}
if (!dir.exists("output/Figure_1/")) dir.create("output/Figure_1/")

cur_sce <- sce_imc[,sce_imc$sample_id == "IMMUcan_2022_WFLOW_10067433-SPECT-VAR-TIS-01-IMC-01_001"]

p <- plotSpatial(cur_sce, 
            node_color_by = "external_celltypes",
            img_id = "sample_id", node_size_fix = 2) +
  scale_color_manual(values = metadata(sce_imc)$colour_vectors$cell_types) +
  theme(axis.text = element_blank(),
        legend.position = "None") +
  ggtitle("")

ggsave("output/Figure_1/Figure_1A_1.pdf", p)
```

### mIF Example image

```{r}
cur_sce <- sce_mIF[,sce_mIF$Lausanne_id == "IMMU-BC2-0755"]

p <- plotSpatial(cur_sce, 
            node_color_by = "matched_celltype",
            img_id = "sample_id", node_size_fix = 0.1,
            coords = c("nucleus.x", "nucleus.y")) +
  scale_color_manual(values = metadata(sce_mIF)$color_vectors$matched_celltype) +
  theme(axis.text = element_blank(),
        legend.position = "None") +
  ggtitle("")

ggsave("output/Figure_1/Figure_1A_2.pdf", p, width = 12, height = 12)
```
